# ç”Ÿæˆè¾¾æ¢¦çš„æ•°æ®åˆå§‹åŒ–è„šæœ¬

## èƒŒæ™¯ä»‹ç»

ä¸ºé€‚åº”**å›½äº§åŒ–é€‚é…**çš„éœ€æ±‚ï¼Œæˆ‘ä»¬é€‰æ‹©ä½¿ç”¨è¾¾æ¢¦ï¼ˆ`DM8` ï¼‰æ•°æ®åº“æ›¿ä»£ MySQL åšä¸ºå›½äº§åŒ–ç‰ˆæœ¬äº§å“æ–¹æ¡ˆçš„å­˜å‚¨ã€‚

æˆ‘ä»¬æœ€ç»ˆçš„å¯¼æ•°æ–¹æ¡ˆï¼š

1. å°†è¡¨ç»“æ„æ–‡ä»¶å¯¼åˆ°`MySQL`ä¸­åšä¸­è½¬
2. ä½¿ç”¨è¾¾æ¢¦è‡ªå¸¦çš„ `DTS` å·¥å…·å°†è¡¨ç»“æ„å’Œæ•°æ®å¯¼å…¥è‡³è¾¾æ¢¦ä¸­
3. åœ¨è¾¾æ¢¦ä¸­å¯¹è¡¨ç»“æ„è¿›è¡Œä¿®æ”¹ã€‚
4. ä½¿ç”¨è„šæœ¬å¯¹è¡¨ç»“æ„å’Œæ•°æ®è¿›è¡Œæ ¡éªŒ
5. ä½¿ç”¨è¾¾æ¢¦è‡ªå¸¦çš„ `DTS` å°†è¡¨ç»“æ„å’Œæ•°æ®å¯¼å‡ºä¸ºSQLè„šæœ¬

**ä¸ºä½•é€‰æ‹©è¿™æ ·çš„ä¸€ä¸ªæ–¹æ¡ˆå‘¢ï¼Ÿ**

è¿™æ˜¯å› ä¸º MySQL å’Œ DM è¯­æ³•ä¸åŒä¸”å„è‡ªéƒ½æœ‰ä¸€å®šçš„è‡ªèº«é™åˆ¶ã€‚ DTS å·¥å…·è™½å¸¦æœ‰ä¸€å®šçš„å­—æ®µé•¿åº¦æ˜ å°„åŠŸèƒ½ï¼Œä½†å¤šæ¬¡æµ‹è¯•å‘ç°å…¶å¹¶æœªç”Ÿæ•ˆï¼Œè‹¥é€ä¸€å¯¹å­—æ®µè¿›è¡Œä¿®æ”¹ï¼Œåˆè¿‡åˆ†æµªè´¹äººåŠ›ã€‚ å°¤å…¶åœ¨æµ‹è¯•é˜¶æ®µï¼Œé¢‘ç¹çš„å¯¼å…¥å¯¼å‡ºæ“ä½œï¼Œæ›´æ˜¯å¾—ä¸å¿å¤±ã€‚

æˆ‘å°†åœ¨æ¥ä¸‹æ¥çš„æ¯ä¸ªæ­¥éª¤ä¸­è§£é‡Šé€‰æ‹©è¿™ä¸ªå¯¼æ•°æ–¹æ¡ˆçš„åŸå› å’Œå¿…è¦æ€§ã€‚   


## MySQL å’Œ DM çš„è¯­æ³•å·®åˆ«

### ä¸ºè¡¨å’Œå­—æ®µæ·»åŠ æ³¨é‡Šçš„æ–¹æ³•ä¸åŒ

\[MySQL\] ç›´æ¥å†™åœ¨è¡¨ã€å­—æ®µå®šä¹‰çš„åé¢ï¼Œä¾‹å¦‚:

```text
CREATE TABLE `tbl_test` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT 'è‡ªå¢ä¸»é”®',
  ...

  `auto_create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'è®°å½•åˆ›å»ºæ—¶é—´',
  `auto_update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'è®°å½•æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin COMMENT='æµ‹è¯•ç”¨è¡¨'
```

\[DM\] ä½¿ç”¨å•ç‹¬è¯­å¥æ·»åŠ :

```text
COMMENT ON TABLE "TEST"."TBL_TEST" IS 'æµ‹è¯•ç”¨è¡¨';
...

COMMENT ON COLUMN "TEST"."TBL_TEST"."ID" IS 'è‡ªå¢ä¸»é”®';
```

### ç‰¹æ®Šè¡¨åã€åˆ—åçš„å£°æ˜

æœ‰çš„æ—¶å€™ï¼Œè®¾è®¡ä¸å¤Ÿè§„èŒƒï¼Œè¡¨åã€åˆ—åå¯èƒ½ä¸æ•°æ®åº“çš„ä¿ç•™å­—é‡åã€‚

\[MySQL\] é€šå¸¸ä½¿ç”¨åå¼•å·ï¼Œæ¯”å¦‚ï¼š

```text
mysql> CREATE TABLE `desc` ( `desc` varchar(256) );
Query OK, 0 rows affected (0.02 sec)

mysql> desc `desc`;
+-------+--------------+------+-----+---------+-------+
| Field | Type         | Null | Key | Default | Extra |
+-------+--------------+------+-----+---------+-------+
| desc  | varchar(256) | NO   |     |         |       |
+-------+--------------+------+-----+---------+-------+
1 row in set (0.02 sec)
```

\[DM\] é€šå¸¸ä½¿ç”¨åŒå¼•å·ï¼ˆç”¨åå¼•å·ç›´æ¥æŠ¥é”™ï¼‰ï¼Œæ¯”å¦‚ï¼š

```text
CREATE TABLE "desc" ( "desc" varchar(256) );
```

### å°† varchar ç±»å‹ä¿®æ”¹ä¸º text ç±»å‹çš„è¯­æ³•

\[MySQL\] ç›´æ¥ä½¿ç”¨ alter å‘½ä»¤ä¿®æ”¹ï¼š

```text
mysql> alter table tbl_test modify `name` text;
Query OK, 0 rows affected (0.02 sec)
Records: 0  Duplicates: 0  Warnings: 0
```

\[DM8\] æ— æ³•é€šè¿‡å‘½ä»¤å°†å·²å®šä¹‰çš„è¡¨ä¸­å­—æ®µç”± varchar ä¿®æ”¹ä¸º textï¼Œä¼šæŠ¥é”™ï¼š`-6160ï¼šæ•°æ®ç±»å‹çš„å˜æ›´æ— æ•ˆ`ã€‚

**å¿…é¡»è¦ drop è¡¨åé‡å»ºæ‰è¡Œ**ï¼ŒåŒç±»çš„è¿˜æœ‰ blobï¼Œclob ç­‰ç±»å‹ã€‚   


### varchar ç±»å‹é•¿åº¦å«ä¹‰ä¸åŒ

\[MySQL\] å‡è®¾ç°åœ¨è¡¨ tbl\_test æœ‰ varchar\(128\) çš„å­—æ®µ name, æˆ‘ä»¬æ˜¯çœŸæ­£çš„å¯ä»¥æŠŠ 128 ä¸ªè‹±æ–‡å­—ç¬¦ã€æ±‰å­—å­—ç¬¦ã€emoji å­—ç¬¦æ’å…¥åˆ°è¯¥å­—æ®µä¸­çš„ã€‚ å¦‚ä¸‹ï¼š

```text
-- åˆ›å»ºæµ‹è¯•è¡¨
CREATE TABLE `tbl_test` (
  `id` int(11) DEFAULT NULL,
  `name` varchar(128) COLLATE utf8mb4_bin DEFAULT NULL
) ENGINE=InnoDB


-- æ’å…¥æµ‹è¯•æ•°æ®ï¼Œåˆ†åˆ«ä¸ºè‹±æ–‡å­—ç¬¦ã€æ±‰å­—å­—ç¬¦ã€emoji å­—ç¬¦
-- æ³¨æ„ client ã€connection ã€column å­—ç¬¦é›†éƒ½è¦æ±‚æ˜¯ utf8mb4

mysql> insert into tbl_test values (1,repeat('a', 128)), (2,repeat('ä¸­',128)), (3,repeat('ğŸ˜„',128));
Query OK, 3 rows affected (0.03 sec)
Records: 3  Duplicates: 0  Warnings: 0


-- æŸ¥çœ‹å­—ç¬¦é•¿åº¦å’Œå­—èŠ‚é•¿åº¦
mysql> select  id, char_length(name), length(name) from tbl_test;
+------+-------------------+--------------+
| id   | char_length(name) | length(name) |
+------+-------------------+--------------+
|    1 |               128 |          128 |
|    2 |               128 |          384 |
|    3 |               128 |          512 |
+------+-------------------+--------------+
3 rows in set (0.02 sec)
```

å¯ä»¥çœ‹åˆ°ï¼šåœ¨ utf8mb4 å­—ç¬¦é›†ä¸‹ï¼Œè‹±æ–‡å ç”¨1ä¸ªå­—èŠ‚ï¼Œä¸€èˆ¬æ±‰å­—å 3ä¸ªå­—èŠ‚ï¼Œemojiè¡¨æƒ…å 4ä¸ªå­—èŠ‚ã€‚ **MySQL çš„ varchar é•¿åº¦æ˜¾ç„¶æ˜¯ä»¥å­—ç¬¦é•¿åº¦ä¸ºå‡†çš„**

\[DM\] è¾¾æ¢¦ä¸­åˆ™ä¸ç„¶

```text
-- åˆ›å»ºæµ‹è¯•è¡¨
CREATE TABLE tbl_test ( id int DEFAULT NULL,  name varchar(128))

-- æ’å…¥è‹±æ–‡å­—ç¬¦
SQL> insert into tbl_test values (1,repeat('a', 128))
SQLRowCount returns 1

-- æ’å…¥ä¸­æ–‡å­—ç¬¦ï¼ˆæŠ¥é”™ï¼‰
insert into tbl_test values (2,repeat('ä¸­', 128))
æ‰§è¡Œå¤±è´¥ï¼šåˆ—[NAME]é•¿åº¦è¶…å‡ºå®šä¹‰

-- æµ‹è¯•å‘ç°ï¼Œä¸­æ–‡å­—ç¬¦ä¿®æ”¹ä¸º  <= 128/3 çš„é•¿åº¦å¯æ’å…¥
insert into tbl_test values (2,repeat('ä¸­', 42))

-- æŸ¥çœ‹å­—ç¬¦é•¿åº¦å’Œå­—èŠ‚é•¿åº¦
SQL> SELECT ID,LENGTH(name),CHAR_LENGTH(name),OCTET_LENGTH(name) FROM tbl_test;
+------------+-------------+------------------+-------------------+
| ID         | LENGTH(name)| CHAR_LENGTH(name)| OCTET_LENGTH(name)|
+------------+-------------+------------------+-------------------+
| 1          | 128         | 128              | 128               |
| 2          | 42          | 42               | 126               |
+------------+-------------+------------------+-------------------+
SQLRowCount returns 2
2 rows fetched
```

å¯ä»¥çœ‹å‡ºï¼š 

1. **è¾¾æ¢¦ä¸­ varchar çš„é•¿åº¦è®¡ç®—çš„æ˜¯å­—èŠ‚æ•°** 

2. æ‰€ä»¥ï¼Œè¾¾æ¢¦ä¸­ varchar\(128\) æ˜¯å­˜ä¸ä¸‹ 128 ä¸ªæ±‰å­—çš„ï¼Œæœ€å¤šåªèƒ½å­˜ 42 ä¸ªï¼ˆè·Ÿå­—ç¬¦é›†æœ‰å…³ï¼‰ã€‚ 

3. è¾¾æ¢¦ä¸­çš„ length å‡½æ•°è®¡ç®—çš„ä¹Ÿæ˜¯å­—ç¬¦æ•°ï¼Œå¦‚æœè¦è®¡ç®—å­—èŠ‚æ•°ï¼Œåº”è¯¥ä½¿ç”¨å‡½æ•°ï¼šOCTET\_LENGTH

## å°†è¡¨ç»“æ„æ–‡ä»¶å¯¼åˆ°`MySQL`ä¸­åšä¸­è½¬

**ä¸ºä»€ä¹ˆä¸ç›´æ¥ç”Ÿæˆ `DM` é€‚é…çš„æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬ï¼Ÿ**

å¦‚ä¸Šæ–‡æ‰€è¿°ï¼ŒDM å’Œ MySQL è¯­æ³•ç•¥æœ‰ä¸åŒï¼Œæ˜¯ä¸èƒ½å°† MySQL å¯¼å‡ºçš„ sql è¯­å¥ç›´æ¥å¯¼å…¥åˆ° DM ä¸­ç›´æ¥ä½¿ç”¨çš„ã€‚

è¯•å›¾åœ¨ sql è¯­å¥å±‚é¢è½¬åŒ–ï¼Œå¿…ç„¶éœ€è¦è°ƒç ”ã€æµ‹è¯•ç”šè‡³æ˜¯å¼€å‘ã€æ”¹å†™è½¬åŒ–è„šæœ¬ï¼Œæ¯”è¾ƒéº»çƒ¦ï¼Œä¹Ÿéš¾å…ä¼šæœ‰é—æ¼ã€‚

æ—¢ç„¶ DM è½¯ä»¶åŒ…ä¸­æä¾›äº† DTSï¼Œæˆ‘ä»¬ä¹Ÿæ„¿æ„ç›¸ä¿¡å®˜æ–¹çš„å·¥å…·ï¼Œå°±æ²¡å¿…è¦æµªè´¹é‚£ä¸ªäººåŠ›äº†ã€‚

**ä¸ºä»€ä¹ˆé€‰æ‹© MySQL ä½œä¸ºä¸­è½¬ï¼Ÿ**

* ä¸€ç›´ä»¥æ¥æˆ‘ä»¬éƒ½æ˜¯ä½¿ç”¨ MySQL ä½œä¸ºæ ‡å‡†ç‰ˆçš„æ•°æ®åº“ï¼Œæ‰€ä»¥æ— è®ºå¦‚ä½•éƒ½è¦å‡†å¤‡ MySQL ç‰ˆæœ¬çš„æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬ã€‚
* åœ¨å¼€å‘å’Œæµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦åŸºäº MySQL è¿›è¡Œï¼Œæ‰€ä»¥åº“ã€è¡¨ã€æ•°æ®å¯ä»¥è¯´æ˜¯ç°æˆçš„ï¼Œåªéœ€è¦åšäº›æ ‡å‡†åŒ–å¤„ç†ï¼Œç®€å•æ˜“å¾—ã€‚

ä¸­è½¬æ“ä½œï¼š 

1. å°†æ•°æ®åˆå§‹åŒ–è„šæœ¬ï¼Œä½¿ç”¨ source å‘½ä»¤å¯¼å…¥åˆ° MySQL ä¸­ 

2. å°†é•¿åº¦è¶…è¿‡ 975 çš„ varchar ç±»å‹å­—æ®µä¿®æ”¹ä¸º text ç±»å‹



### **ä¸ºä»€ä¹ˆè¦å°† &gt;975 çš„ varchar è½¬ä¸º textï¼Ÿ**

æˆ‘ä»¬å¯ä»¥é€šè¿‡ `varchar ç±»å‹é•¿åº¦å«ä¹‰ä¸åŒ` è¿™ä¸ªæ¨¡å—çœ‹åˆ°ï¼Œ ä¸ºäº†è®© MySQL ä¸­çš„æ•°æ®èƒ½å¤Ÿé¡ºåˆ©çš„å¯¼å…¥åˆ° DM ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å¯¹ varchar ç±»å‹çš„å­—æ®µåš `æ‰©å……` å¤„ç†ã€‚ æ‰©å……åï¼Œæœ‰äº›å­—æ®µä¼šè¶…å‡ºé•¿åº¦é™åˆ¶ï¼Œæ‰€ä»¥è¦å‡çº§ä¸º text ç±»å‹

**ä¸ºä»€ä¹ˆé€‰æ‹© 975 è¿™ä¸ªé•¿åº¦ï¼Ÿ**

DM å¯¹äº varchar æœ€å¤§é•¿åº¦çš„æ”¯æŒï¼Œå’Œé¡µçš„å¤§å°æœ‰å…³ï¼š

* 8k çš„é¡µï¼Œvarchar æœ€å¤§é•¿åº¦æ˜¯ï¼š3900
* 16k çš„é¡µï¼Œ varchar æœ€å¤§é•¿åº¦æ˜¯ï¼š8000

æˆ‘ä»¬çš„é¡µå¤§å°æ˜¯ 16k çš„ï¼Œæœ€é•¿æ˜¯å¯ä»¥æ”¯æŒåˆ° 8000 çš„ã€‚ åªæ˜¯ toB ä¸šåŠ¡ï¼Œè¦åœ¨å½±å“èŒƒå›´å¯æ§çš„æƒ…å†µä¸‹ï¼Œè€ƒè™‘åˆ°å…¼å®¹æ›´å¤šçš„å®¢æˆ·çš„ç¯å¢ƒï¼Œæ‰€ä»¥æˆ‘ä»¬è®¾ 3900 ä¸ºä¸Šé™ã€‚

æŒ‰ MySQL ä¸­æœ€å å­—èŠ‚çš„ emoji å­—ç¬¦è®¡ç®—ï¼š 3900/4 = 975 ï¼ˆemoji 1 ä¸ªå­—ç¬¦å  4 ä¸ªå­—èŠ‚ï¼‰

ä¸”ï¼Œç»è¿‡æ’æŸ¥å¯ä»¥ç¡®å®šï¼Œäº§å“å¯¹ &gt;975 çš„è¿™äº›å­—æ®µæ²¡æœ‰ `ç´¢å¼•`ã€`æ¡ä»¶æŸ¥è¯¢` ç­‰éœ€æ±‚ï¼Œæ‰€ä»¥æ”¹æˆ text ä¹Ÿä¸ä¼šæœ‰ä¸¥é‡å½±å“ã€‚

**ä¸ºä»€ä¹ˆè¦åœ¨ MySQL ä¸­åš text è½¬åŒ–æ“ä½œï¼Ÿ**

åœ¨ `å°† varchar ç±»å‹ä¿®æ”¹ä¸º text ç±»å‹çš„è¯­æ³•` éƒ¨åˆ†ï¼Œå·²ç»å‘å¤§å®¶é˜è¿°ï¼Œ DM æ˜¯æ— æ³•è¿›è¡Œè¿™ä¸ªä¿®æ”¹çš„ï¼Œæ‰€ä»¥è¿™æ­¥å¿…é¡»åœ¨ MySQL ä¸­å®Œæˆã€‚

åœ¨ MySQLä¸­æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š

```text
-- ä»ç³»ç»Ÿè¡¨ä¸­æŸ¥çœ‹é•¿åº¦è¶…è¿‡ 975 çš„å­—æ®µéƒ½æœ‰å“ªäº›
select  * from information_schema.columns where table_schema = 'test' and data_type = 'varchar' and CHARACTER_MAXIMUM_LENGTH > 975;

-- ç”Ÿæˆä¿®æ”¹è¯­å¥
select concat('alter table ',TABLE_SCHEMA, '.', TABLE_NAME, ' MODIFY ' ,COLUMN_NAME, ' TEXT;')  from information_schema.columns where table_schema = 'test' and  DATA_TYPE = 'varchar'  and CHARACTER_MAXIMUM_LENGTH > 975;

-- æ‰§è¡Œç”Ÿæˆçš„ä¿®æ”¹è¯­å¥
alter table test.test_tbl MODIFY person_desc TEXT;
alter table ...
```

## åœ¨è¾¾æ¢¦ä¸­å¯¹è¡¨ç»“æ„è¿›è¡Œä¿®æ”¹

### å°† char ç±»å‹å­—æ®µä¿®æ”¹ä¸º varchar ç±»å‹

**ä¸ºä»€ä¹ˆéœ€è¦å°† char æ”¹ä¸º varcharï¼Ÿ**

åœ¨æµ‹è¯•çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å‘ç°äº†è¿™æ ·çš„ä¸€ä¸ªé—®é¢˜ï¼šDM8 å¯¹ char ç±»å‹çš„å­—ç¬¦ä¸²åœ¨æœ«å°¾ç»™è¡¥äº†ç©ºæ ¼ï¼Œè‡´ä½¿æ•°æ®å†…å®¹ä¸å®é™…æœ‰æ‰€å‡ºå…¥ã€‚

è¯·çœ‹ä¸‹é¢çš„ç¤ºä¾‹ï¼š

\[DM8\] ç°åœ¨æœ‰è¡¨ tbl\_test é‡Œé¢çš„å­—æ®µ name ä¸º char ç±»å‹ï¼Œå®šä¹‰çš„é•¿åº¦ä¸º 64ï¼Œä½¿ç”¨ `isql` å·¥å…·è¿›è¡ŒæŸ¥çœ‹ï¼Œ å¯ä»¥çœ‹åˆ°ä¸è¶³ 64 ä½çš„ name è¢«è¡¥äº†ç©ºæ ¼ï¼š

```text
SQL>  select concat('--',name,'--') from tbl_test where id = 1;
+-----------------------------------------------------------------------------------+
| concat(concat('--',name),'--')                                                    |
+-----------------------------------------------------------------------------------+
| --name000000000000000000                                          --              |
+-----------------------------------------------------------------------------------+
```

ç»æµ‹è¯•å‘ç°**è¿™äº›ç©ºæ ¼å®é™…ä¸Šæ˜¯åœ¨æŸ¥è¯¢çš„æ—¶å€™è¡¥ä¸Šçš„**ï¼Œè€Œéå°±æ˜¯è¿™æ ·å­˜å‚¨çš„ã€‚

éªŒè¯æ–¹æ³•ï¼Œä½¿ç”¨ `update` å¯¹å…¨è¡¨çš„ name å­—æ®µå»ç©ºæ ¼ï¼Œä¹‹åå†æ¬¡æŸ¥è¯¢ï¼ˆç»“æœæ²¡æœ‰ä¸€ä¸ä¸æ”¹å˜ï¼‰ï¼š

```text
SQL> update tbl_test set name = trim(name)
SQLRowCount returns 1741

SQL>  select concat('--',name,'--') from tbl_test where id = 1;
+-----------------------------------------------------------------------------------+
| concat(concat('--',name),'--')                                                    |
+-----------------------------------------------------------------------------------+
| --name000000000000000000                                          --              |
+-----------------------------------------------------------------------------------+
```

å¯¹äºè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬æœ‰ä¸‰ä¸ªè§£å†³æ–¹æ¡ˆï¼š 

1. æ‰¾æ‰¾ç³»ç»Ÿå‚æ•°ï¼Œçœ‹æœ‰æ²¡æœ‰å¯ä»¥ä¸è¡¥0çš„

2. æŠŠå­—æ®µé•¿åº¦ä¿®æ”¹ä¸ºå€¼çš„å®é™…é•¿åº¦ï¼š32 

3. æŠŠcharä¿®æ”¹ä¸ºvarcharï¼Œè§„é¿æ‰è¿™ä¸ªé—®é¢˜

å¯¹äºæ–¹æ¡ˆ1ï¼Œç”±äºæˆ‘ä»¬åšçš„æ˜¯ toB ä¸šåŠ¡ï¼Œå®¢æˆ·ç¯å¢ƒåƒå¥‡ç™¾æ€ªï¼Œæœ‰çš„æ˜¯æ­»æ´»ä¸è®©ä½ æ”¹é…ç½®ï¼Œè¿™ä¹ˆåšå°±æ˜¯ç»™è‡ªå·±ç•™å‘ã€‚æ‰€ä»¥ä¸é€‰æ‹©ã€‚

å¯¹äºæ–¹æ¡ˆ2ï¼Œç”±äºæˆ‘ä»¬çš„ä¸šåŠ¡å’Œä½“é‡ï¼Œvarchar å’Œ char å¯¹æˆ‘ä»¬è€Œè¨€æ— è®ºæ˜¯ä»æ€§èƒ½è¿˜æ˜¯ä»ä½¿ç”¨ä¸ŠåŒºåˆ«éƒ½ä¸å¤§ï¼Œè€ƒè™‘åç»­è¿˜æœ‰å¯èƒ½ä¼šæœ‰è¶…è¿‡32ä½çš„æ•°æ®ï¼Œæ‰€ä»¥ç›´æ¥é€‰æ‹©æ–¹æ¡ˆ3ï¼Œä¸€åŠ³æ°¸é€¸ã€‚

**ä¸ºä»€ä¹ˆé€‰æ‹©åœ¨ DM ä¸­åšè¿™ä¸ªæ“ä½œï¼Ÿ**

å› ä¸ºæˆ‘å¸Œæœ› MySQL ä¸­çš„è¡¨ç»“æ„æœ€èƒ½å¤Ÿè´´è¿‘ä¸šåŠ¡çš„éœ€æ±‚ï¼Œæœ€èƒ½å¤Ÿä¿æŒ"åŸæ±åŸå‘³"ï¼Œä¸è¦å› ä¸ºåç»­çš„é€‚é…è€Œè¢«éšæ„ä¿®æ”¹ã€‚

å…·ä½“ä¿®æ”¹æ–¹æ³•ï¼š

```text
-- ä»ç³»ç»Ÿè¡¨ä¸­æŸ¥å‡ºæ‰€æœ‰ char ç±»å‹çš„å­—æ®µ
SELECT * FROM SYS.DBA_TAB_COLUMNS WHERE OWNER ='TEST' AND DATA_TYPE = 'CHAR';


-- ç”Ÿæˆä¿®æ”¹è¯­å¥
select
        concat('alter table ', owner, '.', table_name, ' modify ', column_name, ' varchar(', data_length, ');')
FROM
        SYS.DBA_TAB_COLUMNS
WHERE
        OWNER     ='TEST'
    AND DATA_TYPE = 'CHAR'


-- æ‰¹é‡æ‰§è¡Œç”Ÿæˆå‡ºæ¥çš„ä¿®æ”¹è¯­å¥
alter table TEST.TBL_TEST modify NAME varchar(64);
alter table ...
```

### å°† varchar ç±»å‹å­—æ®µé•¿åº¦æ‰©å¤§ä¸ºä¹‹å‰çš„å››å€

åŒï¼šä¸Šæ–‡ `varchar ç±»å‹é•¿åº¦å«ä¹‰ä¸åŒ` å’Œ `MySQL ä¸­è½¬` éƒ¨åˆ†æ‰€è¿°

**ä¸ºä»€ä¹ˆé€‰æ‹©åœ¨ DM ä¸­åšè¿™ä¸ªæ“ä½œï¼Ÿ**

é™¤äº†å¸Œæœ›MySQLä¸­çš„è¡¨ç»“æ„"åŸæ±åŸå‘³"å¤–ï¼Œè¿˜æœ‰ä¸¤ä¸ªé‡è¦åŸå› ï¼š

1.å—åˆ°äº†ç´¢å¼•çš„çº¦æŸã€‚MySQL ä¸­çš„ç´¢å¼•é™åˆ¶ï¼š

> å”¯ä¸€ç´¢å¼•çš„å­—æ®µé•¿åº¦è¦å°äº 757 , ç»„åˆç´¢å¼•è¦å°äº 3072

è´¸ç„¶å¢åŠ å­—æ®µé•¿åº¦ï¼Œå¯èƒ½ä¼šå¼•å‘ `ERROR 1071 (42000): Specified key was too long; max key length is 3072 bytes` æŠ¥é”™

2.ä½¿ç”¨ modify åœ¨ MySQL ä¸­ä¿®æ”¹å­—æ®µé•¿åº¦ä¼šè¦†ç›–æ‰å…¶ä»–çº¦æŸå’Œå±æ€§ã€‚æ¯”å¦‚ï¼š

```text
-- åˆ›å»ºå¸¦æœ‰éç©ºçº¦æŸã€é»˜è®¤å€¼ã€æ³¨é‡Šçš„è¡¨ï¼š
create table tinatest (id int, name varchar(30) not null default 'tina' comment 'tina');

-- ä¿®æ”¹å­—æ®µé•¿åº¦ï¼š
alter table tinatest modify name varchar(120);

-- æŸ¥çœ‹è¡¨ç»“æ„ï¼Œå¯ä»¥çœ‹åˆ°ï¼šçº¦æŸã€é»˜è®¤å€¼ã€æ³¨é‡Šéƒ½æ²¡äº†
mysql> show create table tinatest;
+----------+-----------------------------------------------------------+
| Table    | Create Table                                              |
+----------+-----------------------------------------------------------+
| tinatest | CREATE TABLE `tinatest` (
  `id` int(11) DEFAULT NULL,
  `name` varchar(120) DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8 |
+----------+-----------------------------------------------------------+
1 row in set (0.02 sec)
```

è€Œ DM ä¸­æ²¡æœ‰è¿™ä¸ªé—®é¢˜ï¼š

```text
-- åˆ—çš„åˆå§‹çŠ¶æ€
"NAME" VARCHAR(128) DEFAULT 'TEST' NOT NULL,

-- ä¿®æ”¹åˆ—çš„é•¿åº¦
ALTER TABLE TEST.TBL_TEST  MODIFY NAME VARCHAR(496)

-- å½“å‰åˆ—çš„çŠ¶æ€
"ACCOUNT_KEY" VARCHAR(496) DEFAULT 'TEST' NOT NULL,
```

å¯ä»¥çœ‹åˆ° default å€¼ï¼Œå’Œ not null çº¦æŸéƒ½è¿˜åœ¨ã€‚

è¾¾æ¢¦ä¸­æ“ä½œ:

```text
-- ç”Ÿæˆä¿®æ”¹è¯­å¥

SELECT
        concat('alter table ', owner, '.', table_name, ' modify ', column_name, ' varchar2(', DATA_LENGTH*4, ');' )
FROM
        SYS.DBA_TAB_COLUMNS
WHERE
        OWNER ='TEST'
    AND
        (
                DATA_TYPE ='VARCHAR'
             OR DATA_TYPE ='VARCHAR2'
        )
    AND DATA_LENGTH <=975


-- æ‰¹é‡æ‰§è¡Œä¿®æ”¹è¯­å¥
alter table TEST.TBL_TEST modify NAME VARCHAR2(512);
alter table ...
```

**æ³¨æ„ï¼š** 

1. ä¿®æ”¹ char -&gt; varchar 

2. ä¿®æ”¹é•¿åº¦è¶…è¿‡ 975 çš„ varchar -&gt; text 

3. ä¿®æ”¹é•¿åº¦å°äºç­‰äº 975 çš„ varchar length \*4

**è¿™ä¸‰æ­¥è¦æŒ‰é¡ºåºæ‰§è¡Œ**

## ä½¿ç”¨è„šæœ¬å¯¹è¡¨ç»“æ„å’Œæ•°æ®è¿›è¡Œæ ¡éªŒ

è¡¨ç»“æ„å’Œçº¦æŸæ ¡éªŒï¼š æˆ‘ä»¬ä½¿ç”¨ MySQL å’Œ DM ä¸­çš„ç³»ç»Ÿè¡¨å¯¹è¡¨ç»“æ„å’Œçº¦æŸåšæ ¡éªŒã€‚å¸¸ç”¨çš„ç³»ç»Ÿè¡¨ã€è§†å›¾ï¼š

MySQL: 

1. information\_schema.tables è¡¨ä¿¡æ¯ 

2. information\_schema.columns åˆ—ä¿¡æ¯ 

3. information\_schema.statistics ç´¢å¼•ä¿¡æ¯



DM: 

1. SYS.All\_ALL\_TABLES è¡¨ä¿¡æ¯ 

2. SYS.DBA\_TAB\_COLUMNS åˆ—ä¿¡æ¯ 

3. SYS.DBA\_INDEXES ç´¢å¼•ä¿¡æ¯

  
æ•°æ®æ ¡éªŒï¼š

æˆ‘ä¹‹å‰ fork äº† beego ORMï¼Œå¼€å‘äº†å…¼å®¹è¾¾æ¢¦ç‰ˆæœ¬ï¼Œæˆ‘ä»¬çš„æ•°æ®æ ¡éªŒå°±æ˜¯ä½¿ç”¨è¿™ä¸ª ORM åŒæ—¶è¿æ¥ DM å’Œ MySQL ï¼Œè¿›è¡Œæ•°æ®çš„æŸ¥è¯¢å’Œæ¯”å¯¹çš„ã€‚ä¹‹åè¿™ä¸ªé¡¹ç›®ä¼šå¼€æºï¼Œæ¬¢è¿å¤§å®¶ä½¿ç”¨ã€‚

